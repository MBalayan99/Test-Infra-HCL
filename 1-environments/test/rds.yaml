#source: dasmeta/rds/aws
#version: 1.4.0

#variables:
 # identifier: "test-mysql"
  #engine: "mysql"
  #engine_version: "8.0"

  #instance_class: "db.t3.micro"
  #allocated_storage: 20
  #storage_type: "gp2"
  #storage_encrypted: true
  #multi_az: false

  #db_name: "testdb"
  #db_username: "admin"
  #db_password: "Test1234!"
  #port: 3306

  #publicly_accessible: false
  #backup_retention_period: 7

  # Security group ID from rds-sg workspace
  #vpc_security_group_ids:
   # - ${1-environments/test/rds-sg.security_group_id}

  # Private subnets from VPC workspace
  #subnet_ids: ${1-environments/test/vpc.private_subnets}

  #tags:
   # Environment: "test"
    #Project: "Test-Infra-HCL"
    #Owner: "mher"

 # alarms:
  #  name: "cpu_utilization_high"
   # enabled: true
    #comparison_operator: "GreaterThanThreshold"
    #evaluation_periods: 1
    #threshold: 80
    #statistic: "Average"
    #period: 300
    #sns_topic: "Default"

#linked_workspaces:
 # - "1-environments/test/vpc"
  #- "1-environments/test/rds-sg"

#providers:
 # - name: aws
  #  version: "~> 5.0"
   # module_nested_provider: true
    #variables:
     # region: "eu-central-1"
source: dasmeta/rds/aws
version: 1.4.0

variables:
  identifier: rds-instance
  engine: mysql
  engine_version: "8.0"
  instance_class: db.t2.micro
  allocated_storage: 20
  storage_type: gp2
  storage_encrypted: true
  multi_az: false
  db_name: testdb
  db_username: admin
  db_password: Test1234!
  port: 3306
  publicly_accessible: false
  backup_retention_period: 7

  # Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ðµ Ð¿Ð¾Ð´ÑÐµÑ‚Ð¸ Ð¸Ð· VPC
  subnet_ids: ${linked_workspaces.vpc.outputs.private_subnets}

  # ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ SG Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸
  create_security_group: true
  security_group_name: "rds-instance-sg"
  security_group_description: "Security group for RDS instance"
  ingress_with_cidr_blocks:
    - from_port: 3306
      to_port: 3306
      protocol: tcp
      cidr_blocks:
        - "10.16.0.0/16"  # Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½ ÑÐµÑ‚Ð¸ VPC, Ñ€Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿

  # Ð¢ÐµÐ³Ð¸
  tags:
    Environment: test
    Project: Test-Infra-HCL
    Owner: mher-test

  # ðŸ”” Alarms (CloudWatch)
  alarms:
    - name: "cpu_utilization_high"
      enabled: true
      comparison_operator: "GreaterThanThreshold"
      evaluation_periods: 1
      threshold: 80
      statistic: "Average"
      period: 300
      sns_topic: "Default"

linked_workspaces:
  - name: vpc
    path: 1-environments/test/vpc

providers:
  - name: aws
    version: "~> 5.0"
    module_nested_provider: true
    variables:
      region: eu-central-1
      default_tags:
        tags:
          Account: mher-test
          ManageLevel: environment

