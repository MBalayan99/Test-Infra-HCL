# Source and version of the RDS module
source: dasmeta/rds/aws
version: 1.4.0

variables:
  # RDS instance settings
  identifier: "rds-instance"          # Name of the RDS instance
  engine: "mysql"                     # Database engine
  engine_version: "8.0"               # Version of the engine
  instance_class: "db.t3.micro"       # Instance type
  allocated_storage: 20               # Storage size in GB
  storage_type: "gp2"                 # Storage type (general purpose SSD)
  storage_encrypted: true             # Enable encryption at rest
  multi_az: false                     

  db_name: "testdb"                   # Initial database name
  db_username: "admin"                # Master username
  db_password: "Test1234!"            # Master password
  port: 3306                          # Port

  publicly_accessible: false           # Do not expose DB publicly
  backup_retention_period: 7           # Backup retention in days

  # Use VPC private subnets (IDs from linked workspace)
  subnet_ids: ${1-environments/test/vpc.private_subnets}
  vpc_id: ${1-environments/test/vpc.id}

  # Security group creation
  create_security_group: true
  security_group_name: "rds-instance-sg"
  security_group_description: "Security group for RDS instance"

  # Ingress rules for security group
  ingress_with_cidr_blocks:
    - from_port: 3306
      to_port: 3306
      protocol: "tcp"
      cidr_blocks: "10.16.0.0/16"  # Must be string, not a list

  # CloudWatch alarm (object)
  alarms:
    enabled: true
    sns_topic: "Default"
    custom_values:
      name: "cpu_utilization_high"
      comparison_operator: "GreaterThanThreshold"
      evaluation_periods: 1
      threshold: 80
      statistic: "Average"
      period: 300

  # Tags for the RDS instance
  tags:
    Environment: "test"
    Project: "Test-Infra-HCL"
    Owner: "mher-test"

# Linked workspaces to retrieve outputs (e.g., private subnets)
linked_workspaces:
  - "1-environments/test/vpc"

# AWS provider configuration
providers:
  - name: aws
    version: "~> 5.0"
    module_nested_provider: true
    variables:
      region: "eu-central-1"
      default_tags:
        tags:
          Account: "mher-test"
          ManageLevel: "environment"
output:
  sensitive: true
